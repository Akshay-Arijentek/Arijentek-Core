{% extends "templates/web.html" %}

{% block title %}Employee Portal - Arijentek{% endblock %}

{% block page_content %}
<div class="employee-portal">
    <header class="portal-header">
        <div class="logo">
            <h1>üè¢ Arijentek</h1>
        </div>
        <div class="user-info">
            <span id="employee-name">Loading...</span>
            <button class="btn-logout" onclick="frappe.session_user && frappe.call({method: 'logout'}).then(() => location.reload())">Logout</button>
        </div>
    </header>

    <section class="clock-section">
        <div class="clock-card">
            <div class="current-time">
                <span id="current-time">--:--:--</span>
                <span id="current-date">Loading...</span>
            </div>
            <div class="timer-display" id="timer-display">
                <span class="timer-value" id="timer-value">00:00:00</span>
                <span class="timer-label" id="timer-label">Not Clocked In</span>
            </div>
            <div class="clock-buttons">
                <button class="btn clock-in" id="btn-clock-in" onclick="clockIn()">
                    üü¢ Clock In
                </button>
                <button class="btn clock-out" id="btn-clock-out" onclick="clockOut()" disabled>
                    üî¥ Clock Out
                </button>
            </div>
            <div class="status-indicator" id="status-indicator"></div>
        </div>
    </section>

    <section class="quick-actions">
        <div class="action-grid">
            <div class="action-card" onclick="showLeaveSection()">
                <span class="action-icon">üìÖ</span>
                <span class="action-label">Apply Leave</span>
            </div>
            <div class="action-card" onclick="showLeaveStatus()">
                <span class="action-icon">üìã</span>
                <span class="action-label">Leave Status</span>
            </div>
            <div class="action-card" onclick="showPayslips()">
                <span class="action-icon">üí∞</span>
                <span class="action-label">Payslips</span>
            </div>
            <div class="action-card" onclick="showIssues()">
                <span class="action-icon">‚ö†Ô∏è</span>
                <span class="action-label">Raise Issue</span>
            </div>
        </div>
    </section>

    <section class="content-area" id="content-area">
        </section>

    <section class="leave-balance">
        <h3>Leave Balance</h3>
        <div class="balance-grid" id="leave-balance-grid">
            Loading...
        </div>
    </section>

    <section class="attendance-summary">
        <h3>This Month</h3>
        <div class="summary-grid" id="attendance-summary">
            Loading...
        </div>
    </section>
</div>

<style>
/* ... (KEEP YOUR EXACT CSS STYLES HERE - Omitted for brevity, paste your CSS here) ... */
:root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --neutral-100: #f8fafc;
    --neutral-200: #e2e8f0;
    --neutral-800: #1e293b;
    --neutral-900: #0f172a;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
}

.employee-portal {
    max-width: 480px;
    margin: 0 auto;
    padding: 16px;
    min-height: 100vh;
}

/* Header */
.portal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 0;
    color: white;
}

.portal-header h1 {
    font-size: 1.5rem;
    font-weight: 700;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.btn-logout {
    background: rgba(255,255,255,0.2);
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-size: 0.875rem;
}

/* Clock Section */
.clock-section {
    margin: 20px 0;
}

.clock-card {
    background: white;
    border-radius: 24px;
    padding: 32px;
    text-align: center;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
}

.current-time {
    margin-bottom: 24px;
}

#current-time {
    display: block;
    font-size: 3rem;
    font-weight: 700;
    color: var(--neutral-900);
    font-variant-numeric: tabular-nums;
}

#current-date {
    color: #64748b;
    font-size: 0.875rem;
}

.timer-display {
    background: var(--neutral-100);
    border-radius: 16px;
    padding: 24px;
    margin: 20px 0;
    transition: all 0.3s ease;
}

.timer-value {
    display: block;
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--neutral-800);
    font-variant-numeric: tabular-nums;
}

.timer-label {
    font-size: 0.875rem;
    color: #64748b;
    margin-top: 8px;
    display: block;
}

/* Timer States */
.timer-display.early {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
}

.timer-display.ready {
    background: linear-gradient(135deg, #d1fae5, #a7f3d0);
}

.timer-display.overtime {
    background: linear-gradient(135deg, #fee2e2, #fecaca);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
    50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
}

/* Buttons */
.clock-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 20px;
}

.btn {
    padding: 16px 32px;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.clock-in {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.clock-in:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.clock-out {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.clock-out:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
}

/* Quick Actions */
.quick-actions {
    margin: 24px 0;
}

.action-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.action-card {
    background: white;
    border-radius: 16px;
    padding: 24px 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.action-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}

.action-icon {
    font-size: 2rem;
    display: block;
    margin-bottom: 8px;
}

.action-label {
    font-weight: 600;
    color: var(--neutral-800);
    font-size: 0.875rem;
}

/* Content Area */
.content-area {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin: 24px 0;
    display: none;
}

.content-area.active {
    display: block;
}

/* Leave Balance */
.leave-balance, .attendance-summary {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin: 16px 0;
}

.leave-balance h3, .attendance-summary h3 {
    color: var(--neutral-800);
    margin-bottom: 16px;
    font-size: 1rem;
}

.balance-grid, .summary-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
}

.balance-item, .summary-item {
    text-align: center;
    padding: 12px;
    background: var(--neutral-100);
    border-radius: 12px;
}

.balance-value, .summary-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
}

.balance-label, .summary-label {
    font-size: 0.75rem;
    color: #64748b;
    margin-top: 4px;
}

/* Status Indicator */
.status-indicator {
    margin-top: 16px;
    padding: 12px;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
}

.status-indicator.info {
    background: #dbeafe;
    color: #1e40af;
}

.status-indicator.warning {
    background: #fef3c7;
    color: #92400e;
}

.status-indicator.success {
    background: #d1fae5;
    color: #065f46;
}

/* Responsive */
@media (max-width: 360px) {
    .action-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    #current-time {
        font-size: 2.5rem;
    }
    
    .timer-value {
        font-size: 2rem;
    }
}
</style>

<script>
// Global state
let clockInTime = null;
let timerInterval = null;
let employeeId = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
    loadEmployeeData();
    checkExistingClockIn();
    loadLeaveBalance();
    loadAttendanceSummary();
});

// Update current time display
function updateCurrentTime() {
    const now = new Date();
    document.getElementById('current-time').textContent = 
        now.toLocaleTimeString('en-IN', { hour12: false });
    document.getElementById('current-date').textContent = 
        now.toLocaleDateString('en-IN', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
}

// Load employee data - UPDATED TO USE ARIJENTEK_CORE
function loadEmployeeData() {
    frappe.call({
        method: 'arijentek_core.api.get_employee_info',
        callback: function(r) {
            if (r.message) {
                document.getElementById('employee-name').textContent = r.message.employee_name;
                employeeId = r.message.employee_id;
            }
        }
    });
}

// Check for existing clock-in today - UPDATED TO USE ARIJENTEK_CORE
function checkExistingClockIn() {
    frappe.call({
        method: 'arijentek_core.api.get_today_checkin',
        callback: function(r) {
            if (r.message && r.message.clock_in && !r.message.clock_out) {
                clockInTime = new Date(r.message.clock_in);
                startTimer();
                document.getElementById('btn-clock-in').disabled = true;
                document.getElementById('btn-clock-out').disabled = false;
            }
        }
    });
}

// Clock In - UPDATED TO USE ARIJENTEK_CORE
function clockIn() {
    frappe.call({
        method: 'arijentek_core.api.clock_in',
        callback: function(r) {
            if (r.message && r.message.success) {
                clockInTime = new Date();
                startTimer();
                document.getElementById('btn-clock-in').disabled = true;
                document.getElementById('btn-clock-out').disabled = false;
                showStatus('‚úÖ Clocked in at ' + clockInTime.toLocaleTimeString(), 'success');
            } else {
                showStatus('‚ùå ' + (r.message.error || 'Clock in failed'), 'warning');
            }
        },
        error: function(e) {
            showStatus('‚ùå Error: ' + e.message, 'warning');
        }
    });
}

// Clock Out - UPDATED TO USE ARIJENTEK_CORE
function clockOut() {
    const elapsedHours = getElapsedHours();
    
    if (elapsedHours < 4) {
        if (!confirm('‚ö†Ô∏è You have worked less than 4 hours. This will be marked as ABSENT. Continue?')) {
            return;
        }
    } else if (elapsedHours < 8) {
        if (!confirm('‚ö†Ô∏è You have worked less than 8 hours. This may be marked as HALF DAY. Continue?')) {
            return;
        }
    }
    
    frappe.call({
        method: 'arijentek_core.api.clock_out',
        callback: function(r) {
            if (r.message && r.message.success) {
                stopTimer();
                document.getElementById('btn-clock-in').disabled = false;
                document.getElementById('btn-clock-out').disabled = true;
                showStatus('‚úÖ Clocked out. Worked: ' + formatTime(getElapsedSeconds()), 'success');
            } else {
                showStatus('‚ùå ' + (r.message.error || 'Clock out failed'), 'warning');
            }
        }
    });
}

// Timer functions
function startTimer() {
    document.getElementById('timer-label').textContent = 'Time Worked Today';
    updateTimer();
    timerInterval = setInterval(updateTimer, 1000);
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    document.getElementById('timer-label').textContent = 'Session Complete';
}

function updateTimer() {
    if (!clockInTime) return;
    
    const elapsed = getElapsedSeconds();
    const hours = getElapsedHours();
    
    document.getElementById('timer-value').textContent = formatTime(elapsed);
    
    const timerDisplay = document.getElementById('timer-display');
    timerDisplay.classList.remove('early', 'ready', 'overtime');
    
    if (hours >= 9) {
        timerDisplay.classList.add('overtime');
        document.getElementById('timer-label').textContent = '‚ö†Ô∏è Overtime - Please clock out!';
    } else if (hours >= 8) {
        timerDisplay.classList.add('ready');
        document.getElementById('timer-label').textContent = '‚úÖ 8 hours complete - Safe to clock out';
    } else if (hours >= 4) {
        timerDisplay.classList.add('early');
        document.getElementById('timer-label').textContent = '‚è≥ ' + (8 - hours).toFixed(1) + ' hours remaining';
    } else {
        document.getElementById('timer-label').textContent = '‚è≥ Less than 4 hours worked';
    }
}

function getElapsedSeconds() {
    if (!clockInTime) return 0;
    return Math.floor((new Date() - clockInTime) / 1000);
}

function getElapsedHours() {
    return getElapsedSeconds() / 3600;
}

function formatTime(totalSeconds) {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return [hours, minutes, seconds].map(v => String(v).padStart(2, '0')).join(':');
}

// Status display
function showStatus(message, type) {
    const indicator = document.getElementById('status-indicator');
    indicator.textContent = message;
    indicator.className = 'status-indicator ' + type;
}

// Load leave balance - UPDATED TO USE ARIJENTEK_CORE
function loadLeaveBalance() {
    frappe.call({
        method: 'arijentek_core.api.get_leave_balance',
        callback: function(r) {
            if (r.message) {
                let html = '';
                r.message.forEach(function(item) {
                    html += `
                        <div class="balance-item">
                            <div class="balance-value">${item.balance}</div>
                            <div class="balance-label">${item.leave_type}</div>
                        </div>
                    `;
                });
                document.getElementById('leave-balance-grid').innerHTML = html || 'No leave allocated';
            }
        }
    });
}

// Load attendance summary - UPDATED TO USE ARIJENTEK_CORE
function loadAttendanceSummary() {
    frappe.call({
        method: 'arijentek_core.api.get_attendance_summary',
        callback: function(r) {
            if (r.message) {
                document.getElementById('attendance-summary').innerHTML = `
                    <div class="summary-item">
                        <div class="summary-value">${r.message.present || 0}</div>
                        <div class="summary-label">Present</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${r.message.absent || 0}</div>
                        <div class="summary-label">Absent</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${r.message.half_day || 0}</div>
                        <div class="summary-label">Half Day</div>
                    </div>
                `;
            }
        }
    });
}

// Navigation functions
function showLeaveSection() {
    const content = document.getElementById('content-area');
    content.classList.add('active');
    content.innerHTML = `
        <h3>Apply for Leave</h3>
        <form id="leave-form" style="margin-top: 16px;">
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Leave Type</label>
                <select id="leave-type" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    <option value="">Loading...</option>
                </select>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">From Date</label>
                    <input type="date" id="from-date" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">To Date</label>
                    <input type="date" id="to-date" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                </div>
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                    <input type="checkbox" id="half-day"> Half Day
                </label>
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Reason</label>
                <textarea id="leave-reason" rows="3" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;"></textarea>
            </div>
            <button type="button" onclick="submitLeave()" class="btn" style="width: 100%; background: var(--primary); color: white;">
                Submit Leave Request
            </button>
        </form>
    `;
    loadLeaveTypes();
}

// UPDATED TO USE ARIJENTEK_CORE
function loadLeaveTypes() {
    frappe.call({
        method: 'arijentek_core.api.get_leave_types',
        callback: function(r) {
            if (r.message) {
                const select = document.getElementById('leave-type');
                select.innerHTML = r.message.map(t => 
                    `<option value="${t}">${t}</option>`
                ).join('');
            }
        }
    });
}

// UPDATED TO USE ARIJENTEK_CORE
function submitLeave() {
    const data = {
        leave_type: document.getElementById('leave-type').value,
        from_date: document.getElementById('from-date').value,
        to_date: document.getElementById('to-date').value,
        half_day: document.getElementById('half-day').checked ? 1 : 0,
        reason: document.getElementById('leave-reason').value
    };
    
    frappe.call({
        method: 'arijentek_core.api.apply_leave',
        args: data,
        callback: function(r) {
            if (r.message && r.message.success) {
                alert('‚úÖ Leave application submitted!');
                document.getElementById('content-area').classList.remove('active');
                loadLeaveBalance();
            } else {
                alert('‚ùå ' + (r.message.error || 'Failed to submit leave'));
            }
        }
    });
}

// UPDATED TO USE ARIJENTEK_CORE
function showLeaveStatus() {
    const content = document.getElementById('content-area');
    content.classList.add('active');
    content.innerHTML = '<h3>Leave Applications</h3><div id="leave-list" style="margin-top: 16px;">Loading...</div>';
    
    frappe.call({
        method: 'arijentek_core.api.get_leave_applications',
        callback: function(r) {
            if (r.message && r.message.length) {
                let html = '';
                r.message.forEach(function(leave) {
                    const statusColor = leave.status === 'Approved' ? '#10b981' : 
                                       leave.status === 'Rejected' ? '#ef4444' : '#f59e0b';
                    html += `
                        <div style="padding: 16px; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <strong>${leave.leave_type}</strong>
                                <span style="color: ${statusColor}; font-weight: 500;">${leave.status}</span>
                            </div>
                            <div style="color: #64748b; font-size: 0.875rem;">
                                ${leave.from_date} to ${leave.to_date} (${leave.total_leave_days} days)
                            </div>
                            ${leave.status === 'Open' ? `
                                <button onclick="cancelLeave('${leave.name}')" 
                                    style="margin-top: 8px; padding: 8px 16px; background: #fef2f2; color: #dc2626; border: none; border-radius: 6px; cursor: pointer;">
                                    Cancel
                                </button>
                            ` : ''}
                        </div>
                    `;
                });
                document.getElementById('leave-list').innerHTML = html;
            } else {
                document.getElementById('leave-list').innerHTML = '<p style="color: #64748b; text-align: center;">No leave applications found</p>';
            }
        }
    });
}

// UPDATED TO USE ARIJENTEK_CORE
function cancelLeave(leaveName) {
    if (!confirm('Are you sure you want to cancel this leave application?')) return;
    
    frappe.call({
        method: 'arijentek_core.api.cancel_leave',
        args: { leave_application: leaveName },
        callback: function(r) {
            if (r.message && r.message.success) {
                alert('‚úÖ Leave cancelled');
                showLeaveStatus();
            } else {
                alert('‚ùå ' + (r.message.error || 'Failed to cancel leave'));
            }
        }
    });
}

// UPDATED TO USE ARIJENTEK_CORE
function showPayslips() {
    const content = document.getElementById('content-area');
    content.classList.add('active');
    content.innerHTML = '<h3>Salary Slips</h3><div id="payslip-list" style="margin-top: 16px;">Loading...</div>';
    
    frappe.call({
        method: 'arijentek_core.api.get_salary_slips',
        callback: function(r) {
            if (r.message && r.message.length) {
                let html = '';
                r.message.forEach(function(slip) {
                    html += `
                        <div style="padding: 16px; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${slip.month} ${slip.year}</strong>
                                <div style="color: #64748b; font-size: 0.875rem;">Net Pay: ‚Çπ${slip.net_pay.toLocaleString()}</div>
                            </div>
                            <a href="/api/method/arijentek_core.api.download_payslip?name=${slip.name}" 
                                target="_blank"
                                style="padding: 8px 16px; background: var(--primary); color: white; border-radius: 6px; text-decoration: none;">
                                Download
                            </a>
                        </div>
                    `;
                });
                document.getElementById('payslip-list').innerHTML = html;
            } else {
                document.getElementById('payslip-list').innerHTML = '<p style="color: #64748b; text-align: center;">No salary slips found</p>';
            }
        }
    });
}

function showIssues() {
    const content = document.getElementById('content-area');
    content.classList.add('active');
    content.innerHTML = `
        <h3>Raise an Issue</h3>
        <form style="margin-top: 16px;">
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Issue Type</label>
                <select id="issue-type" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    <option value="Attendance Discrepancy">Attendance Discrepancy</option>
                    <option value="Salary Issue">Salary Issue</option>
                    <option value="Leave Balance">Leave Balance</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Description</label>
                <textarea id="issue-description" rows="4" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;" placeholder="Describe your issue in detail..."></textarea>
            </div>
            <button type="button" onclick="submitIssue()" class="btn" style="width: 100%; background: var(--warning); color: white;">
                Submit Issue
            </button>
        </form>
    `;
}

// UPDATED TO USE ARIJENTEK_CORE
function submitIssue() {
    const data = {
        issue_type: document.getElementById('issue-type').value,
        description: document.getElementById('issue-description').value
    };
    
    frappe.call({
        method: 'arijentek_core.api.create_issue',
        args: data,
        callback: function(r) {
            if (r.message && r.message.success) {
                alert('‚úÖ Issue submitted! Ticket: ' + r.message.ticket);
                document.getElementById('content-area').classList.remove('active');
            } else {
                alert('‚ùå ' + (r.message.error || 'Failed to submit issue'));
            }
        }
    });
}
</script>
{% endblock %}